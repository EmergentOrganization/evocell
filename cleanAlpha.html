<html>
<head>
<style>
#dropzone {
height: 150px;
width: 100%;
-webkit-border-radius: 10px;
-khtml-border-radius: 10px;
-moz-border-radius: 10px;
border-radius: 10px;
border: 2px dashed #0687FF;
}
</style>
<script src="src/helpers.js"></script>
<script src="src/evocell.js"></script>
<script src="src/jquery-1.6.2.min.js"></script>

<script id="shader-vs-passthrough" type="x-shader/x-vertex"> 
  attribute vec3 aPos;
  attribute vec2 aTexCoord;
  varying   vec2 vTexCoord;
void main(void) {
   gl_Position = vec4(aPos, 1.);
   vTexCoord = aTexCoord;
}
</script> 

<script id="shader-fs-palette" type="x-shader/x-fragment"> 
#ifdef GL_ES
precision highp float;
#endif
  uniform sampler2D texFrame;
  varying vec2 vTexCoord;
void main(void) 
{
   vec4 color = texture2D(texFrame, vTexCoord);
   gl_FragColor = vec4(color.a*100.0, color.a*color.a*color.a*200000.0, 0., 1.);
   
	//gl_FragColor = texture2D(texFrame, vTexCoord);
}
</script> 

<script type="text/javascript">

var gl, cnvs, textureGOL, texture1, texture2, fb1, fb2, progCA, progShow, frameCount, frameFlip;
var width;
var height;
var randomDensity;

var timer, time = 0, frames = 0;


function setup()
{

document.getElementById('evocellFile').addEventListener('change', handleFileSelect, false);


clearInterval(timer);

	width = 500;
	height = 333;
	
	document.getElementById('xres').value = width;
	document.getElementById('yres').value = height;

	cnvs =  document.getElementById("c");
	cnvs.width = width;
	cnvs.height = height;
	gl = getGL(cnvs);


	
	// TODO get this from canvas initialy

	
	textureGOL = createGOLTexture(gl);
	
//	progCA  = gl.createProgram();
//	gl.attachShader(progCA, getShaderFromElement( gl, "shader-vs-passthrough" ));
//	gl.attachShader(progCA, getShaderFromElement( gl, "shader-moore2" ));
//	gl.linkProgram(progCA);
	
	progShow = gl.createProgram();
	gl.attachShader(progShow, getShaderFromElement( gl, "shader-vs-passthrough" ));
	gl.attachShader(progShow, getShaderFromElement( gl, "shader-fs-palette" ));
	gl.linkProgram(progShow);

	var caSpace = createCASpace(gl);
	bindCASpaceToShader(gl, progCA, caSpace);
	bindCASpaceToShader(gl, progShow, caSpace);
	
	texture1 = createFrameTextureRandom(gl, width, height, 0.1);
	texture2 = createFrameTextureRandom(gl, width, height, 0.1);
	
	fb1 = gl.createFramebuffer();
   	gl.bindFramebuffer(gl.FRAMEBUFFER, fb1);
   	gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, texture1, 0);
   	
   	fb2 = gl.createFramebuffer();
   	gl.bindFramebuffer(gl.FRAMEBUFFER, fb2);
   	gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, texture2, 0);
	
	frameCount = 0;
	frameFlip = 1;
	
	

	
	
	
	
	
	var file = getArrayBufferFromURL(
	//"http://dl.dropbox.com/u/2297128/22C3_avgextgrowers_cooler",
	//"http://dl.dropbox.com/u/2297128/Moore4-avg3-sweetship",
	//"ccc_rules/gridworld7",
	//"ccc_rules/ecoli16",
	//"ccc_rules/annegret2", 
	//"ccc_rules/g2adapded", 
	//"ccc_rules/moore5-explosionz-spaceshyp-boxedin-mut",
	//"ccc_rules/moore5-explosionz-spaceshyp-boxedin-mut",
	//"ccc_rules/orientalischenachtschattengewaechse",
	//"ccc_rules/interestingreplicator2",
	//"ccc_rules/new/22C3_mirrorsymetric_gliders-randomwaver",
	//"ccc_rules/starburst_road", 
	//"ccc_rules/march", 
	//"ccc_rules/machines/gardener/g2adapded",
	//"ccc_rules/s5-2", 
	"ccc_rules/evoloop/EvoloopN9",
	function (arrayBuffer) {
		arrayBufferData = arrayBuffer;
		
		var evoCellData = loadEvoCellFile(arrayBuffer);
		oldEvoCellData = evoCellData;
		loadProgFromEvoCellData(evoCellData, width, height);
		
		
		timer = setInterval(fr, 500);
		time = new Date().getTime();
   
		anim();
		//updateFrame();
	});
	
	
	
	
}

function loadProgFromEvoCellData(evoCellData, xres, yres)
{
	//var evoCellData = loadEvoCellFile(arrayBuffer);
	textureGOL = generateEvoCellTexture(gl, evoCellData);
	var newProgCA  = gl.createProgram();
	gl.attachShader(newProgCA, getShaderFromElement( gl, "shader-vs-passthrough" ));
	gl.attachShader(newProgCA, getShaderFromEvoCellData( gl, evoCellData, xres, yres));
	gl.linkProgram(newProgCA);
	progCA = newProgCA; // atomic change
}

var arrayBufferData;
var oldEvoCellData;

function handleReset()
{
	width = parseInt(document.getElementById('xres').value);
	height = parseInt(document.getElementById('yres').value);
	randomDensity = parseFloat(document.getElementById('randomDensity').value);
	
	var evoCellData = loadEvoCellFile(arrayBufferData);
	
	clearInterval(timer);

	cnvs.width = width;
	cnvs.height = height;
	gl.viewport(0, 0, cnvs.width, cnvs.height);
	
	if (evoCellData.containsPattern)
	{
		texture1 = createFrameTextureFromPattern(gl, evoCellData, width, height);
		texture2 = createFrameTextureFromPattern(gl, evoCellData, width, height);
		
		fb1 = gl.createFramebuffer();
		gl.bindFramebuffer(gl.FRAMEBUFFER, fb1);
		gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, texture1, 0);
		
		fb2 = gl.createFramebuffer();
		gl.bindFramebuffer(gl.FRAMEBUFFER, fb2);
		gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, texture2, 0);
		
		loadProgFromEvoCellData(oldEvoCellData, width, height);
	}
	else
	{
		texture1 = createFrameTextureRandom(gl, width, height, randomDensity);
		texture2 = createFrameTextureRandom(gl, width, height, randomDensity);
		
		fb1 = gl.createFramebuffer();
		gl.bindFramebuffer(gl.FRAMEBUFFER, fb1);
		gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, texture1, 0);
		
		fb2 = gl.createFramebuffer();
		gl.bindFramebuffer(gl.FRAMEBUFFER, fb2);
		gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, texture2, 0);
		
		loadProgFromEvoCellData(evoCellData, width, height);
		oldEvoCellData = evoCellData;
	}
}

function handleFileSelect(evt) {
    var files = evt.target.files; // FileList object
	
	var reader = new FileReader();
	reader.onload = function(evt) {	
			arrayBufferData = evt.target.result;
			handleReset();
			
			/*
			ecData = loadEvoCellFile(evt.target.result);
			textureGOL = generateEvoCellTexture(gl, ecData);
			var newProgCA  = gl.createProgram();
			gl.attachShader(newProgCA, getShaderFromElement( gl, "shader-vs-passthrough" ));
			gl.attachShader(newProgCA, getShaderFromEvoCellData( gl, ecData));
			gl.linkProgram(newProgCA);
			progCA = newProgCA; // atomic change
			//document.querySelector('img').src = evt.target.result;
			//*/
		};
	reader.readAsArrayBuffer(files[0]); // start async operation
  
  }
  

</script>


</head>
<body onload="setup()">
	<canvas id="c" width="1000" height="3333"></canvas>

	<form name="controls" action="">
	<input type="button" id="cmdSingleStep" value="one step" onclick="updateFrame();">
	<input type="button" id="cmdRunPause" value="run" onclick="anim();">
	<input type="number" id="xres" name="xres" min="100" max="4000" value="1000" onchange="handleReset();" />
	<input type="number" id="yres" name="yres" min="100" max="4000" value="3333" onchange="handleReset();" />
	<input type="number" id="randomDensity" min="0" max="1" step="0.001" value="0.01" onchange="handleReset();">
	<input type="button" value="Reset" onclick="handleReset();">
	<input type="file" value="evocellFile" id="evocellFile" />
	fps<input size="1" id="framerate">
	
	</form>
</body>
</html>