<html lang="en-us">
<head>
	<link type="text/css" rel="stylesheet" href="style.css" />
	<script src="src/helpers.js"></script>
	<script src="src/evocell.js"></script>
	<script src="src/evocellweb.js"></script>
	<script src="src/jquery-1.6.2.min.js"></script>

	<script id="shader-vs-passthrough" type="x-shader/x-vertex"> 
		attribute vec3 aPos;
		attribute vec2 aTexCoord;
		varying   vec2 vTexCoord;

		void main(void) {
			gl_Position = vec4(aPos, 1.);
			vTexCoord = aTexCoord;
		}
	</script> 

	<script id="shader-fs-palette" type="x-shader/x-fragment"> 
		#ifdef GL_ES
		precision highp float;
		#endif
		uniform sampler2D texFrame;
		varying vec2 vTexCoord;
		void main(void) {
			vec4 color = texture2D(texFrame, vTexCoord);
			gl_FragColor = vec4(color.a*100.0, color.a*color.a*color.a*200000.0, 0., 1.);
   
			//gl_FragColor = texture2D(texFrame, vTexCoord);
		}
	</script>

<script type="text/javascript">

var nrSims = 4;
var caCanvas, caSims;
var timer, time;
var width, height;
var progShow;
var ctlXRes, ctlYRes, ctlRandomDensity, ctlFramerate;

function setup()
{
	ctlXRes = $('#xres')[0];
	ctlYRes = $('#yres')[0];
	ctlRandomDensity = $('#randomDensity');
	ctlFramerate = $('#framerate')[0];
	
	document.getElementById('c').addEventListener('click', handleCanvasClick, false);
	
	$('#evocellFile').change(handleFileSelect);
	clearInterval(timer);

	width = 1680;
	height = 1050;
	
	ctlXRes.value = width;
	ctlYRes.value = height;
	
	caCanvas = new EvoCell.CACanvas($("#c")[0]);
	caCanvas.setSize(width, height);
	
	progShow = caCanvas.gl.createProgram();
	caCanvas.gl.attachShader(progShow, getShaderFromElement(caCanvas.gl, "shader-vs-passthrough" ));
	caCanvas.gl.attachShader(progShow, getShaderFromElement(caCanvas.gl, "shader-fs-palette" ));
	caCanvas.gl.linkProgram(progShow);
	var caSpace = createCASpace(caCanvas.gl);
	bindCASpaceToShader(caCanvas.gl, progShow, caSpace);
	
	
	var file = getArrayBufferFromURL(
	//"http://dl.dropbox.com/u/2297128/22C3_avgextgrowers_cooler",
	//"http://dl.dropbox.com/u/2297128/Moore4-avg3-sweetship",
	"rules/gridworld6",
	//"ccc_rules/ecoli16",
	//"ccc_rules/annegret2", 
	//"ccc_rules/g2adapded", 
	//"ccc_rules/moore5-explosionz-spaceshyp-boxedin-mut",
	//"ccc_rules/moore5-explosionz-spaceshyp-boxedin-mut",
	//"ccc_rules/orientalischenachtschattengewaechse",
	//"ccc_rules/interestingreplicator2",
	//"ccc_rules/new/22C3_mirrorsymetric_gliders-randomwaver",
	//"ccc_rules/starburst_road", 
	//"ccc_rules/march", 
	//"ccc_rules/machines/gardener/g2adapded",
	//"ccc_rules/s5-2", 
	//"ccc_rules/evoloop/EvoloopN9",
	function (arrayBuffer) {
		arrayBufferData = arrayBuffer;
		
		var evoCellData = EvoCell.loadEvoCellFile(arrayBuffer);
		caSims = [];
		
		for (var i = 0; i < nrSims; i++)
			caSims[i] = new EvoCell.CASimulation(caCanvas, evoCellData, width/2-1, height/2-1);
		
	
		timer = setInterval(fr, 1000);
		time = new Date().getTime();
   
		anim();
	});
}

function handleReset()
{
	width = parseInt(ctlXRes.value);
	height = parseInt(ctlYRes.value);
	randomDensity = parseFloat(ctlRandomDensity.value);
	
	caCanvas.setSize(width, height);
	//caSim.setSize(width, height);
}

var delay=5;

requestAnimFrame = (function(){
  return  window.webkitRequestAnimationFrame ||
    window.mozRequestAnimationFrame ||
    function(callback, element){ setTimeout(callback, 1000 / 60); }
})();

function anim(){
	for (var i = 0; i < nrSims; i++)
		caSims[i].step();
   
	caCanvas.draw(caSims[0], progShow, null, [0, 0, width/2-1, height/2-1]);
	caCanvas.draw(caSims[1], progShow, null, [width/2+1, 0, width/2-1, height/2-1]);
	caCanvas.draw(caSims[2], progShow, null, [0, height/2+1, width/2-1, height/2-1]);
	caCanvas.draw(caSims[3], progShow, null, [width/2+1, height/2+1, width/2-1, height/2-1]);

   frames++;
   
   requestAnimFrame(anim);
}

function fr(){
  var ti = new Date().getTime();
  var fps = Math.round(1000*frames/(ti - time));
  ctlFramerate.value = fps;
  frames = 0;  time = ti;
}



function handleFileSelect(evt) {
    var files = evt.target.files; // FileList object
	
	var reader = new FileReader();
	reader.onload = function(evt) {	
			arrayBufferData = evt.target.result;
			var evoCellData = EvoCell.loadEvoCellFile(arrayBufferData);
			caSims[0].setRule(evoCellData);
			handleReset();
		};
	reader.readAsArrayBuffer(files[0]); // start async operation
  }
  
function handleCanvasClick(evt) {
	var canvas = document.getElementById('c');
	
	var coords = canvas.relMouseCoords(evt);
	var x = coords.x;
	var y = coords.y;
	
	var clickedCA = 0;
	
	if (coords.y < height/2)
		clickedCA += 2;
	
	if (coords.x > width/2)
		clickedCA += 1;
	
	//alert(clickedCA);
}  
</script>


</head>
<body onload="setup()">
	<canvas id="c" width="1000" height="3333"></canvas>

	<form name="controls" action="">
	<input type="button" id="cmdSingleStep" value="one step" onclick="updateFrame();">
	<input type="button" id="cmdRunPause" value="run" onclick="anim();">
	<input type="number" id="xres" name="xres" min="100" max="4000" value="1000" onchange="handleReset();" />
	<input type="number" id="yres" name="yres" min="100" max="4000" value="3333" onchange="handleReset();" />
	<input type="number" id="randomDensity" min="0" max="1" step="0.001" value="0.01" onchange="handleReset();">
	<input type="button" value="Reset" onclick="handleReset();">
	<input type="file" value="evocellFile" id="evocellFile" />
	fps<input size="1" id="framerate">
	
	</form>
</body>
</html>
